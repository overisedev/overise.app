<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OVERISE | Catálogo (741)</title>
  <style>
    :root{
      --bg:#050505; --panel:#0f0f0f; --panel2:#111;
      --border:#222; --muted:#777; --text:#fff; --neon:#00FF41;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--text);
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      display:flex; flex-direction:column; align-items:center;
      padding-bottom:60px;
    }
    .brand-header{margin:34px 0 14px; text-align:center}
    h1{margin:0; font-weight:900; font-size:3rem; letter-spacing:-2px; text-transform:uppercase}
    .sub{font-size:12px; letter-spacing:6px; color:#666; margin-top:6px}

    .shell{
      width:92%; max-width:1300px; display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
    }
    @media (max-width: 920px){
      .shell{grid-template-columns: 1fr}
    }

    .panel{
      background:var(--panel); border:1px solid var(--border);
      border-radius:14px; padding:14px;
      box-shadow: 0 0 50px rgba(0,255,65,0.08);
    }

    .search-container{position:sticky; top:12px}
    .input-group{display:flex; border-radius:10px; overflow:hidden; border:1px solid #333}
    input{
      width:100%; padding:16px; background:var(--panel2); border:0; color:var(--neon);
      font-family:monospace; font-size:16px; text-transform:uppercase; outline:none;
    }
    input::placeholder{color:#004411}
    .btn{
      padding:0 22px; background:var(--neon); border:0; color:#000; font-weight:900;
      cursor:pointer; text-transform:uppercase; letter-spacing:1px;
    }
    .btn:hover{background:#fff}
    .msg{margin-top:10px; font-size:12px; color:#666; font-family:monospace}

    .cat-title{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:10px 0 6px}
    .cat-title span{font-weight:800; letter-spacing:1px; font-size:12px; color:#ddd}
    .pill{
      font-family:monospace; font-size:11px; color:var(--neon);
      border:1px solid rgba(0,255,65,0.6); background: rgba(0,255,65,0.08);
      padding:3px 8px; border-radius:999px;
    }
    .cats{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .cat-btn{
      cursor:pointer; user-select:none;
      padding:8px 10px; border-radius:10px;
      background:#0b0b0b; border:1px solid var(--border);
      font-size:12px; font-weight:800; letter-spacing:.5px;
      color:#cfcfcf;
    }
    .cat-btn:hover{border-color:var(--neon)}
    .cat-btn.active{border-color:var(--neon); color:#000; background:var(--neon)}
    .cat-btn small{opacity:.8; font-weight:900}

    #results-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap:18px;
      align-content:start;
    }
    .game-card{
      background:var(--panel); border:1px solid var(--border); border-radius:14px;
      overflow:hidden; display:flex; flex-direction:column;
      transition: transform .25s ease, border-color .25s ease, box-shadow .25s ease;
    }
    .game-card:hover{transform: translateY(-6px); border-color: var(--neon); box-shadow:0 10px 26px rgba(0,255,65,0.12)}
    .imgbox{aspect-ratio:16/9; background:#000; overflow:hidden; position:relative}
    .imgbox img{width:100%; height:100%; object-fit:cover; display:block; transform:scale(1.02); transition: transform .4s ease}
    .game-card:hover .imgbox img{transform:scale(1.06)}
    .info{padding:12px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:10px; flex:1}
    .title{font-weight:900; font-size:12px; letter-spacing:.6px; text-transform:uppercase; line-height:1.25}
    .tags{display:flex; flex-wrap:wrap; gap:6px}
    .tag{
      font-size:10px; font-weight:900; letter-spacing:.6px;
      padding:4px 7px; border-radius:8px;
      border:1px solid rgba(0,255,65,0.6); color:var(--neon);
      background: rgba(0,255,65,0.08);
    }
    .row{display:flex; gap:8px}
    .btn-action{
      width:100%; background:var(--neon); border:0; color:#000;
      padding:10px; font-size:11px; font-weight:900; cursor:pointer;
      text-transform:uppercase; border-radius:10px; letter-spacing:1px;
      margin-top:auto;
    }
    .btn-action:hover{background:#fff}
    .muted{color:var(--muted); font-family:monospace; font-size:11px}
  </style>
</head>
<body>
  <div class="brand-header">
    <h1>OVER<span style="color:var(--neon)">ISE</span></h1>
    <div class="sub">// CATALOGO GLOBAL (741 TÍTULOS)</div>
  </div>

  <div class="shell">
    <aside class="panel search-container">
      <div class="input-group">
        <input id="searchInput" placeholder="PESQUISE SEU JOGO (EX: GTA, FIFA, MINECRAFT)..." />
        <button class="btn" id="scanBtn">SCAN</button>
      </div>
      <div class="msg" id="statusMsg">SISTEMA ONLINE. CARREGANDO DADOS…</div>

      <div class="cat-title">
        <span>CATEGORIAS</span>
        <span class="pill" id="totalCount">0</span>
      </div>
      <div class="cats" id="cats"></div>

      <div style="margin-top:12px" class="muted">
        • Capas: Steam (automático)<br/>
        • Cache: appid salvo no navegador<br/>
        • Carregamento: imagens lazy + fila com limite
      </div>
    </aside>

    <main class="panel">
      <div id="results-grid"></div>
    </main>
  </div>

<script>
/** =========================
 *  CONFIG / PERFORMANCE
 *  ========================= */
const FALLBACK_IMG = "https://media.istockphoto.com/id/1329433253/photo/abstract-digital-background-with-technology-circuit-board-texture-electronic-motherboard.jpg?s=612x612&w=0&k=20&c=f7S_qg2aK5qQO7q7z_X_5X_6X_7X_8X_9X_0X=";

// Steam Store Search (sem API key) — pega o primeiro resultado e usa o appid.
// Referência: endpoint de busca da loja Steam (storesearch).
const STEAM_SEARCH = (term) => `https://store.steampowered.com/api/storesearch/?term=${encodeURIComponent(term)}&l=portuguese&cc=BR`;

// Header oficial:
const STEAM_HEADER = (appid) => `https://shared.fastly.steamstatic.com/store_item_assets/steam/apps/${appid}/header.jpg`;

// Cache no navegador: nome -> appid
const CACHE_KEY = "overise_appid_cache_v1";
let appidCache = {};
try { appidCache = JSON.parse(localStorage.getItem(CACHE_KEY) || "{}"); } catch(e){ appidCache = {}; }

function saveCache(){
  try{ localStorage.setItem(CACHE_KEY, JSON.stringify(appidCache)); } catch(e){}
}

// Fila com limite de concorrência (evita travar o navegador / bater rate-limit)
class FetchQueue {
  constructor(limit=6){
    this.limit = limit;
    this.active = 0;
    this.q = [];
  }
  push(task){
    return new Promise((resolve,reject)=>{
      this.q.push({task,resolve,reject});
      this._next();
    });
  }
  _next(){
    while(this.active < this.limit && this.q.length){
      const {task,resolve,reject} = this.q.shift();
      this.active++;
      Promise.resolve().then(task).then(resolve).catch(reject).finally(()=>{
        this.active--;
        this._next();
      });
    }
  }
}
const coverQueue = new FetchQueue(6);

// Debounce para busca
function debounce(fn, ms=180){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/** =========================
 *  DADOS
 *  ========================= */
let GAMES = [];
let FILTERED = [];
let ACTIVE_CATEGORY = "TODOS";

const statusMsg = document.getElementById("statusMsg");
const grid = document.getElementById("results-grid");
const catsEl = document.getElementById("cats");
const totalCount = document.getElementById("totalCount");
const inputEl = document.getElementById("searchInput");

/** =========================
 *  CATEGORIAS
 *  ========================= */
function buildCategories(games){
  const counts = new Map();
  for(const g of games){
    for(const c of g.categories || ["OUTROS"]){
      counts.set(c, (counts.get(c)||0)+1);
    }
  }
  const sorted = [...counts.entries()].sort((a,b)=>b[1]-a[1]).map(([c,n])=>({c,n}));
  return [{c:"TODOS",n:games.length}, ...sorted];
}

function renderCategories(){
  const cats = buildCategories(GAMES);
  catsEl.innerHTML = cats.map(({c,n})=>{
    const active = (c===ACTIVE_CATEGORY) ? "active" : "";
    return `<div class="cat-btn ${active}" data-cat="${c}">${c} <small>(${n})</small></div>`;
  }).join("");
  totalCount.textContent = String(GAMES.length);
  catsEl.querySelectorAll(".cat-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      ACTIVE_CATEGORY = btn.getAttribute("data-cat");
      renderCategories();
      applyFilters();
    });
  });
}

/** =========================
 *  BUSCA + FILTRO
 *  ========================= */
function normalizeQuery(q){
  q = (q||"").trim().toUpperCase();

  // Apelidos comuns
  if(q === "GTA") q = "GRAND THEFT AUTO";
  if(q === "GTA 5") q = "GRAND THEFT AUTO V";
  if(q === "COD") q = "CALL OF DUTY";
  if(q === "RE4") q = "RESIDENT EVIL 4";
  if(q === "RDR2") q = "RED DEAD REDEMPTION 2";
  if(q === "MK") q = "MORTAL KOMBAT";
  if(q === "ETS2") q = "EURO TRUCK SIMULATOR 2";
  if(q === "NFS") q = "NEED FOR SPEED";
  return q;
}

function applyFilters(){
  const q = normalizeQuery(inputEl.value);
  const qOk = q.length >= 2;

  FILTERED = GAMES.filter(g=>{
    const inCat = (ACTIVE_CATEGORY==="TODOS") ? true : (g.categories||[]).includes(ACTIVE_CATEGORY);
    if(!inCat) return false;
    if(!qOk) return true;
    return g.name.toUpperCase().includes(q);
  });

  statusMsg.innerHTML = `<span style="color:#fff">${FILTERED.length} JOGOS DISPONÍVEIS NO ACERVO.</span>`;
  renderGrid(FILTERED.slice(0, 48)); // primeira página (performance)
}

const applyFiltersDebounced = debounce(applyFilters, 180);

/** =========================
 *  CAPA STEAM (AUTO)
 *  ========================= */
async function resolveSteamAppId(gameName){
  // Se já tem cache:
  if(appidCache[gameName]) return appidCache[gameName];

  // Consulta Steam
  const url = STEAM_SEARCH(gameName);
  const r = await fetch(url, {mode:"cors"});
  const data = await r.json();

  // Heurística: primeiro item "game"
  if(data && data.items && data.items.length){
    const item = data.items[0];
    const appid = item.id;
    if(appid){
      appidCache[gameName] = appid;
      saveCache();
      return appid;
    }
  }
  // Se não encontrou:
  appidCache[gameName] = null;
  saveCache();
  return null;
}

async function loadCoverInto(imgEl, gameName){
  // Evita duplicar
  if(imgEl.dataset.loaded === "1") return;
  imgEl.dataset.loaded = "1";

  try{
    const appid = await resolveSteamAppId(gameName);
    if(appid){
      imgEl.src = STEAM_HEADER(appid);
      imgEl.alt = gameName;
      imgEl.dataset.appid = appid;
    } else {
      imgEl.src = FALLBACK_IMG;
      imgEl.alt = gameName;
      imgEl.dataset.appid = "";
    }
  }catch(e){
    imgEl.src = FALLBACK_IMG;
    imgEl.alt = gameName;
    imgEl.dataset.appid = "";
  }
}

/** =========================
 *  LAZY LOAD COM INTERSECTION OBSERVER
 *  ========================= */
const io = new IntersectionObserver((entries)=>{
  for(const e of entries){
    if(e.isIntersecting){
      const img = e.target;
      const name = img.dataset.name;
      io.unobserve(img);
      coverQueue.push(()=>loadCoverInto(img, name));
    }
  }
}, {rootMargin:"250px"});

/** =========================
 *  RENDER
 *  ========================= */
function renderGrid(list){
  grid.innerHTML = list.map(g=>{
    const cats = (g.categories||["OUTROS"]).slice(0,3); // não poluir
    return `
      <div class="game-card">
        <div class="imgbox">
          <img loading="lazy" data-name="${escapeHtml(g.name)}" src="${FALLBACK_IMG}" alt="${escapeHtml(g.name)}"/>
        </div>
        <div class="info">
          <div class="title">${escapeHtml(g.name)}</div>
          <div class="tags">
            <span class="tag">✓ DISPONÍVEL</span>
            ${cats.map(c=>`<span class="tag">${escapeHtml(c)}</span>`).join("")}
          </div>
          <button class="btn-action" onclick="alert('Iniciando Checkout para: ${escapeAttr(g.name)}')">[ DESBLOQUEAR ]</button>
        </div>
      </div>
    `;
  }).join("");

  // conectar lazy loader
  grid.querySelectorAll("img[data-name]").forEach(img=>io.observe(img));
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
}
function escapeAttr(s){ return String(s).replace(/'/g,"\\'"); }

/** =========================
 *  PAGINAÇÃO SIMPLES (mais performance)
 *  ========================= */
let page = 1;
function renderMore(){
  const perPage = 48;
  const start = page*perPage;
  const next = FILTERED.slice(start, start+perPage);
  if(!next.length) return;
  page++;
  const tmp = document.createElement("div");
  tmp.innerHTML = next.map(g=>{
    const cats = (g.categories||["OUTROS"]).slice(0,3);
    return `
      <div class="game-card">
        <div class="imgbox">
          <img loading="lazy" data-name="${escapeHtml(g.name)}" src="${FALLBACK_IMG}" alt="${escapeHtml(g.name)}"/>
        </div>
        <div class="info">
          <div class="title">${escapeHtml(g.name)}</div>
          <div class="tags">
            <span class="tag">✓ DISPONÍVEL</span>
            ${cats.map(c=>`<span class="tag">${escapeHtml(c)}</span>`).join("")}
          </div>
          <button class="btn-action" onclick="alert('Iniciando Checkout para: ${escapeAttr(g.name)}')">[ DESBLOQUEAR ]</button>
        </div>
      </div>
    `;
  }).join("");
  const cards = [...tmp.children];
  for(const c of cards){
    grid.appendChild(c);
    const img = c.querySelector("img[data-name]");
    if(img) io.observe(img);
  }
}

window.addEventListener("scroll", debounce(()=>{
  const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 900);
  if(nearBottom) renderMore();
}, 120));

/** =========================
 *  INIT
 *  ========================= */
async function init(){
  try{
    // Carrega games.json (741)
    const r = await fetch("./games_741.json");
    GAMES = await r.json();

    statusMsg.textContent = "SISTEMA ONLINE. AGUARDANDO COMANDO.";
    renderCategories();

    FILTERED = GAMES.slice();
    page = 1;
    renderGrid(FILTERED.slice(0, 48));
  }catch(e){
    statusMsg.innerHTML = "<span style='color:orange'>ERRO AO CARREGAR games_741.json</span>";
  }
}

document.getElementById("scanBtn").addEventListener("click", ()=>{
  page = 1;
  applyFilters();
});
inputEl.addEventListener("input", ()=>{
  page = 1;
  applyFiltersDebounced();
});
inputEl.addEventListener("keypress", (e)=>{
  if(e.key === "Enter"){ page=1; applyFilters(); }
});

init();
</script>
</body>
</html>
